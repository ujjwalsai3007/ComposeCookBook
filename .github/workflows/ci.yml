name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  lint-and-test:
    name: ğŸ” Code Quality & Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ğŸ“¦ Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ğŸ”§ Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: ğŸ§¹ Run Lint
      run: ./gradlew lintDebug
      
    - name: ğŸ§ª Run Unit Tests
      run: ./gradlew testDebugUnitTest
      
    - name: ğŸ”¨ Build Debug APK
      run: ./gradlew assembleDebug
      
    - name: ğŸ“Š Upload Lint Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lint-results
        path: app/build/reports/lint-results-debug.html
        
    - name: ğŸ“ˆ Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: app/build/reports/tests/testDebugUnitTest/
        
    - name: ğŸ“± Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/app-debug.apk

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ›¡ï¸ Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: kotlin
        
    - name: â˜• Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ğŸ”§ Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: ğŸ”¨ Build for Analysis
      run: ./gradlew assembleDebug
      
    - name: ğŸ” Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  dependency-check:
    name: ğŸ” Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ğŸ”§ Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: ğŸ“¦ Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ğŸ” Check Dependencies
      run: ./gradlew dependencies
      
    - name: ğŸ“Š Generate Dependency Report
      run: ./gradlew dependencyUpdates

  build-status:
    name: âœ… Build Status
    runs-on: ubuntu-latest
    needs: [lint-and-test, security-scan, dependency-check]
    if: always()
    
    steps:
    - name: ğŸ‰ Success Notification
      if: ${{ needs.lint-and-test.result == 'success' && needs.security-scan.result == 'success' && needs.dependency-check.result == 'success' }}
      run: |
        echo "ğŸ‰ All checks passed! Repository is ready for production."
        echo "âœ… Lint: Passed"
        echo "âœ… Tests: Passed" 
        echo "âœ… Security: Passed"
        echo "âœ… Dependencies: Checked"
        
    - name: âŒ Failure Notification
      if: ${{ needs.lint-and-test.result == 'failure' || needs.security-scan.result == 'failure' || needs.dependency-check.result == 'failure' }}
      run: |
        echo "âŒ Some checks failed. Please review the results."
        echo "Lint: ${{ needs.lint-and-test.result }}"
        echo "Security: ${{ needs.security-scan.result }}"
        echo "Dependencies: ${{ needs.dependency-check.result }}"